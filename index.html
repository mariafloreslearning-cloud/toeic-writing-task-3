<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Write your text</title>

  <style>
    :root{
      --bg:#f3f5f7;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 28px rgba(17,24,39,.08);
      --primary:#2563eb;
      --primaryHover:#1d4ed8;
      --danger:#ef4444;
      --dangerHover:#dc2626;
      --success:#16a34a;
      --successHover:#15803d;
      --ghost:#f9fafb;
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      line-height:1.45;
    }

    .page{
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 16px 64px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding: 24px;
    }

    .title{
      margin: 0;
      font-size: 22px;
      letter-spacing: -0.01em;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .subtitle{
      margin: 10px 0 16px;
      color: var(--muted);
      font-size: 14px;
      max-width: 72ch;
    }

    .prompt{
      margin: 14px 0 18px;
      background:#f7f8fa;
      border:1px solid var(--border);
      border-left: 4px solid #2f6fed;
      border-radius: 12px;
      padding: 14px 14px;
    }
    .prompt h2{
      margin: 0 0 10px;
      font-size: 14px;
      color: #111827;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .prompt p{
      margin: 0 0 12px;
      color:#111827;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .imgWrap{
      margin-top: 10px;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      overflow:hidden;
    }
    .imgWrap img{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 12px;
    }

    .wordsLine{
      margin-top: 12px;
      font-size: 14px;
      color:#111827;
    }
    .wordsLine em{
      font-style: italic;
    }

    .instruction{
      margin-top: 14px;
      font-size: 13px;
      color: #4b5563;
    }

    .meta{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin: 10px 0 14px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      background:#fafafa;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 8px 0 12px;
    }
    button{
      border:0;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      cursor:pointer;
      transition: transform .02s ease, background .15s ease, opacity .15s ease;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnPrimary{ background: var(--primary); color:#fff; }
    .btnPrimary:hover{ background: var(--primaryHover); }

    .btnDanger{ background: var(--danger); color:#fff; }
    .btnDanger:hover{ background: var(--dangerHover); }

    .btnGhost{ background: var(--ghost); color: var(--text); border:1px solid var(--border); }
    .btnGhost:hover{ background:#f3f4f6; }

    .btnSuccess{ background: var(--success); color:#fff; }
    .btnSuccess:hover{ background: var(--successHover); }

    .btnDownload{ background:#0f172a; color:#fff; }
    .btnDownload:hover{ background:#111827; }

    /* ‚úÖ More visible return button */
    .btnReturn{
      background: var(--primary);
      color:#fff;
      padding: 12px 18px;
      font-weight: 700;
      box-shadow: 0 10px 22px rgba(37,99,235,.18);
    }
    .btnReturn:hover{ background: var(--primaryHover); }

    textarea{
      width:100%;
      min-height: 140px;
      margin-top: 6px;
      padding: 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.55;
      outline: none;
      resize: vertical;
      background:#fff;
    }

    /* ‚úÖ Bottom bar layout: left download, right return */
    .bottomBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .bottomBar .spacer{ flex:1; }
    @media (max-width: 520px){
      .bottomBar button{ width:100%; }
      .bottomBar .spacer{ display:none; }
    }

    .hint{
      margin-top: 14px;
      padding: 12px 12px;
      border-left: 4px solid #c7d2fe;
      background:#f5f7ff;
      border-radius: 12px;
      font-size: 13px;
      color: #374151;
    }

    .saved{
      margin-top: 18px;
      border-top:1px solid var(--border);
      padding-top: 16px;
    }
    .saved h3{
      margin: 0 0 10px;
      font-size: 16px;
    }
    .savedList{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .savedItem{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }
    .savedTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .savedLabel{
      display:flex;
      gap:10px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    .tag{
      font-size:12px;
      color:var(--muted);
    }
    .savedActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .linkBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border:1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      text-decoration:none;
      color: var(--text);
      background:#fff;
      cursor:pointer;
    }
    .linkBtn:hover{ background:#f9fafb; }
    .dangerLink{
      border-color:#fecaca;
      color:#991b1b;
      background:#fff5f5;
    }
    .dangerLink:hover{ background:#ffecec; }

    .draftBox{
      background:#fafafa;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.55;
      color:#111827;
    }

    /* PRO overlay */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(17,24,39,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:16px;
      border:1px solid var(--border);
      box-shadow:0 18px 50px rgba(0,0,0,.25);
      padding:18px;
    }
    .modal h3{
      margin:0 0 8px;
      font-size:16px;
    }
    .modal p{
      margin:0 0 12px;
      color:var(--muted);
      font-size:14px;
      line-height:1.55;
    }
    .modal .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    @media (min-width: 980px){
      .card{ padding: 28px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <h1 class="title">‚úçÔ∏è Write your text</h1>
      <div class="subtitle">
        Write <strong>a clear and appropriate response</strong> to the written request.
      </div>

      <div class="prompt" id="promptBox">
  <h2>üìß Respond to a written request</h2>

  <p>Read the e-mail.</p>

  <div class="draftBox">
From: Greenway Office Management  
To: All Building Employees  
Subject: Office Facilities Update  
Sent: September 12, 9:15 A.M.

Dear Employees,

We would like to inform you that several improvements are planned for the Greenway Office Building over the next few weeks. These updates are intended to improve comfort and accessibility for everyone working in the building.

Some changes may temporarily affect access to certain facilities, including meeting rooms and shared workspaces. We appreciate your cooperation during this period and encourage you to contact us if you have any questions or concerns.

Best regards,  
Greenway Office Management
  </div>

  <p class="instruction">
    <strong>Directions:</strong> Respond to the e-mail.<br>
    Respond as if you work in the building. In your reply, make at least <strong>2 requests for information</strong> related to the office updates.
  </p>
</div>

      <div class="meta">
        <div class="pill"><span>‚ÑπÔ∏è</span><span id="status">Ready</span></div>
      </div>

      <div class="controls">
        <button id="save" class="btnSuccess">Save this draft</button>
        <button id="reset" class="btnGhost">Reset</button>
      </div>

      <textarea id="writer" placeholder="Type your sentence here..."></textarea>

      <div class="bottomBar">
        <button id="download" class="btnDownload" disabled>‚¨áÔ∏è Download current draft</button>
        <div class="spacer"></div>
        <button id="returnBtn" class="btnReturn">‚Ü©Ô∏è Return to the module</button>
      </div>

      <div class="hint">
        Your saved drafts stay on this device/browser only. If you‚Äôre on a shared computer, delete your drafts when finished.
        If you want to keep them, download and rename your files.
      </div>

      <div class="saved">
        <h3>Saved drafts</h3>
        <div class="savedList" id="savedList"></div>
      </div>
    </div>
  </div>

  <!-- PRO overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h3 id="modalTitle">Return to the module</h3>
      <p>
        Your browser may block automatic tab closing.
        Please <strong>close this tab manually</strong> to return to the e-learning module.
      </p>
      <div class="row">
        <button id="okBtn" class="btnPrimary">OK</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * IndexedDB (persist drafts like takes)
     ***********************/
    const DB_NAME = "toeic_writing_db_task1";
    const DB_VERSION = 1;
    const STORE = "drafts";

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = () => {
          const db = req.result;
          if(!db.objectStoreNames.contains(STORE)){
            const store = db.createObjectStore(STORE, { keyPath: "id", autoIncrement: true });
            store.createIndex("createdAt", "createdAt");
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function addDraftToDB({ text }){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        const store = tx.objectStore(STORE);
        const req = store.add({
          text,
          createdAt: Date.now()
        });
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function getAllDraftsFromDB(){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const store = tx.objectStore(STORE);
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }

    async function deleteDraftFromDB(id){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        const store = tx.objectStore(STORE);
        const req = store.delete(id);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    /***********************
     * UI
     ***********************/
    const saveBtn = document.getElementById("save");
    const resetBtn = document.getElementById("reset");
    const dlBtn = document.getElementById("download");
    const returnBtn = document.getElementById("returnBtn");

    const writer = document.getElementById("writer");
    const statusEl = document.getElementById("status");
    const savedList = document.getElementById("savedList");

    const overlay = document.getElementById("overlay");
    const okBtn = document.getElementById("okBtn");

    function showOverlay(){ overlay.style.display = "flex"; }
    function hideOverlay(){ overlay.style.display = "none"; }

    okBtn.addEventListener("click", hideOverlay);
    overlay.addEventListener("click", (e) => { if(e.target === overlay) hideOverlay(); });

    function setStatus(msg){ statusEl.textContent = msg; }

    function downloadText(text, filename){
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    function escapeHtml(str){
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function renderSavedDraft({ id, text, createdAt }, draftNumber){
      const item = document.createElement("div");
      item.className = "savedItem";
      item.dataset.id = String(id);

      const top = document.createElement("div");
      top.className = "savedTop";

      const label = document.createElement("div");
      label.className = "savedLabel";
      label.innerHTML = `<strong>Draft ${draftNumber}</strong> <span class="tag">‚Ä¢ saved ${new Date(createdAt).toLocaleString()}</span>`;

      const actions = document.createElement("div");
      actions.className = "savedActions";

      const restoreBtn = document.createElement("a");
      restoreBtn.href = "#";
      restoreBtn.className = "linkBtn";
      restoreBtn.textContent = "‚Ü©Ô∏è Restore";
      restoreBtn.onclick = (e) => {
        e.preventDefault();
        writer.value = text || "";
        dlBtn.disabled = !(writer.value.trim());
        setStatus(`Draft ${draftNumber} restored.`);
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      const copyBtn = document.createElement("a");
      copyBtn.href = "#";
      copyBtn.className = "linkBtn";
      copyBtn.textContent = "üìã Copy";
      copyBtn.onclick = async (e) => {
        e.preventDefault();
        try{
          await navigator.clipboard.writeText(text || "");
          setStatus(`Draft ${draftNumber} copied.`);
        } catch {
          setStatus("Copy failed. Please copy manually.");
        }
      };

      const downloadBtn = document.createElement("a");
      downloadBtn.href = "#";
      downloadBtn.className = "linkBtn";
      downloadBtn.textContent = "‚¨áÔ∏è Download";
      downloadBtn.onclick = (e) => {
        e.preventDefault();
        downloadText(text || "", `writing-task1-draft-${draftNumber}.txt`);
        setStatus(`Draft ${draftNumber} downloaded.`);
      };

      const removeBtn = document.createElement("a");
      removeBtn.href = "#";
      removeBtn.className = "linkBtn dangerLink";
      removeBtn.textContent = "üóëÔ∏è Remove";
      removeBtn.onclick = async (e) => {
        e.preventDefault();
        await deleteDraftFromDB(id);
        item.remove();
        setStatus("Draft removed.");
        await loadSavedDrafts(); // renumber
      };

      actions.appendChild(restoreBtn);
      actions.appendChild(copyBtn);
      actions.appendChild(downloadBtn);
      actions.appendChild(removeBtn);

      top.appendChild(label);
      top.appendChild(actions);

      const box = document.createElement("div");
      box.className = "draftBox";
      box.innerHTML = escapeHtml(text || "");

      item.appendChild(top);
      item.appendChild(box);

      return item;
    }

    async function loadSavedDrafts(){
      savedList.innerHTML = "";
      const drafts = await getAllDraftsFromDB();
      drafts.sort((a,b) => a.createdAt - b.createdAt); // Draft 1 at top

      if(drafts.length === 0){
        const empty = document.createElement("div");
        empty.className = "pill";
        empty.textContent = "No drafts saved yet.";
        savedList.appendChild(empty);
        return;
      }

      drafts.forEach((d, idx) => {
        savedList.appendChild(renderSavedDraft(d, idx + 1));
      });
    }

    function syncCurrentDownloadState(){
      dlBtn.disabled = !(writer.value.trim());
    }

    // Init
    setStatus("Ready");
    loadSavedDrafts().catch(() => {});
    syncCurrentDownloadState();

    writer.addEventListener("input", syncCurrentDownloadState);

    saveBtn.onclick = async () => {
      const text = (writer.value || "").trim();
      if(!text){
        setStatus("Write your sentence first.");
        return;
      }
      try{
        setStatus("Saving draft‚Ä¶");
        await addDraftToDB({ text });
        await loadSavedDrafts();
        setStatus("Draft saved. You can write another one to compare.");
      } catch(err){
        console.error(err);
        setStatus("Save failed (storage blocked?)");
        alert("Saving failed. Your browser may be blocking storage for this page.");
      }
    };

    resetBtn.onclick = () => {
      writer.value = "";
      syncCurrentDownloadState();
      setStatus("Reset.");
    };

    dlBtn.onclick = () => {
      const text = (writer.value || "").trim();
      if(!text) return;
      downloadText(text, `writing-task1-${new Date().toISOString().slice(0,10)}.txt`);
      setStatus("Downloaded current draft.");
    };

    // PRO return: try close, then overlay
    returnBtn.addEventListener("click", (e) => {
      e.preventDefault();
      setStatus("Returning to the module‚Ä¶");

      window.close();

      setTimeout(() => {
        showOverlay();
        setStatus("Please close this tab to return to the module.");
      }, 250);
    });
  </script>
</body>
</html>
